@using SADFM.Data;
@{
    ViewBag.Title = "Providers";
}
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-12">
        <h2>Provider maintenance</h2>
        <ol class="breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Home")">Home</a>
            </li>
            <li>
                <a>Clients</a>
            </li>
            <li class="active">
                <strong>Providers</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2">
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>SADFM Providers</h5>
                    <div class="ibox-tools">
                        <button type="button" class="btn btn-primary btn-newprovider" data-backdrop="static" data-keyboard="false">
                            <i class="fa fa-plus"></i>&nbsp;Add a new Facility
                        </button>
                    </div>
                </div>
                <div class="ibox-content">

                    <table class="table table-striped table-bordered table-hover dataTables-example">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Group</th>
                                <th>Monthly Rate</th>
                                <th>Edit</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Name</th>
                                <th>Group</th>
                                <th>Monthly Rate</th>
                                <th>Edit</th>
                            </tr>
                        </tfoot>
                    </table>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal" id="popupEditor" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="addnewprovider-title">Add a new Facility</h4>
            </div>
            <div class="modal-body">
                <form id="form" action="#" class="wizard-big">
                    <h1>Structure</h1>
                    <fieldset>
                        <h2 id="addnewprovider-sub-title">New Facility Details</h2>
                        <label id="errorNewProvider" style="color: red; display:none">* All fields are required</label>
                        <div class="row">
                            <div class="col-lg-9" id="rowddlStructure">

                            </div>
                            <div class="col-lg-3">
                                <a class="btn btn-primary btn-addstructure" id="btnAddStructure">Add Group</a>
                            </div>
                        </div>
                        <div class="row">&nbsp;</div>
                        <div class="row">
                            <div class="col-lg-9">
                                <input type="text" id="txtProviderName" placeholder="Facility name" class="form-control input-lg m-b" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-9">
                                <input type="text" id="txtMonthlyRate" placeholder="Monthly Rate" class="form-control input-lg m-b" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-4">
                                <img src="~/Content/images/noprovider.png" id="avatar" height="65" />
                            </div>
                            <div class="col-xs-8">
                                <label title="Upload image file" for="inputImage" class="btn btn-primary">
                                    <input type="file" accept="image/*" name="file" id="inputImage" class="hide">
                                    Upload Picture
                                </label>
                            </div>
                           
                        </div>


                    </fieldset>

                    <h1>Service Type</h1>
                    <fieldset>
                        <h2>Select service type</h2>
                        <div class="row">
                            <div class="col-lg-9" id="ServiceTypeParent">

                            </div>
                            <div class="col-lg-3">
                                <button type="button" class="btn btn-primary" id="btn-add-service-type">Add</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="ibox-content" id="tblServiceTypeParent">

                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white btn-closedialog" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-newnext">Next</button>
                <button type="button" class="btn btn-primary btn-newsave disabled">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal" id="popupAddServiceType" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Service Type Information</h4>
                <label id="errorNewServiceType" style="color:red; display:none">* All fields are required</label>
            </div>
            <div class="modal-body">

                <div class="row">
                    <div class="col-lg-12">
                        <h4>Contact Details</h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4">
                        <input id="contactNumber" name="contactNumber" placeholder="Contact number" autocomplete="off" type="text" class="form-control">
                    </div>
                    <div class="col-lg-4">
                        @SADFM.Web.Shared.Constants.CountryComboBox
                    </div>
                    <div class="col-lg-4" id="provinceContainer">
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4">
                        <input id="street" name="street" placeholder="Street" autocomplete="off" type="text" class="form-control">
                    </div>
                    <div class="col-lg-4" id="cityContainer">
                    </div>
                    <div class="col-lg-4">
                        <input id="postalCode" name="postalCode" placeholder="Postal code" autocomplete="off" type="text" class="form-control">
                    </div>
                </div>
                <h4>Scales</h4>
                <br />
                <div style="border: 2px solid #ccc; width: 100%; height: 100px; overflow-y: scroll;" id="scalelist">
                    @foreach (SADFM.Data.Models.ListItem cs in SADFM.Data.DataAccess.ListItem.GetList("Scale", deep: false))
                    {
                        <input type="checkbox" value="@cs.ID" /> <label>@cs.Description </label><br />
                    }
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-modal-add-service">Add</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal" id="popupNewGroup" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Add a new Group</h4>
            </div>
            <div class="modal-body">
                <input type="text" id="newGroupName" style="width: 100%" placeholder="New Group Name" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-savenewgroup">Create new Group</button>
            </div>
        </div>
    </div>
</div>


@section Styles {
    @Styles.Render("~/plugins/dataTablesStyles")
    @Styles.Render("~/plugins/wizardStepsStyles")
    @Styles.Render("~/plugins/chosenStyles")
    <style>
        .chosen-container .chosen-results {
            max-height: 150px;
        }

        #tblServiceType tr:hover {
            cursor: pointer;
        }
    </style>
}

@section Scripts {
    @Scripts.Render("~/plugins/jeditable")
    @Scripts.Render("~/plugins/dataTables")
    @Scripts.Render("~/plugins/wizardSteps")
    @Scripts.Render("~/plugins/validate")
    @Scripts.Render("~/plugins/chosen")
    <script type="text/javascript">
    var tblServiceType;
    var selectedProvinceID = null, selectedCityID = null;
    $(document).ready(function () {

        $("#CountryID").chosen({
            "width": "100%",
            disable_search_threshold: 10
        });


        $('#CountryID').on('change', function () {
            $.get("/patient/GetProvinces?CountryId=" + encodeURIComponent($('#CountryID').val()), function (data) {
                $('#provinceContainer').html(data);
                $("#ProvinceID").chosen({
                    "width": "100%",
                    "height": "10px"
                });

                $('#ProvinceID').on('change', function () {
                    $.get("/patient/GetCities?ProvinceId=" + encodeURIComponent($('#ProvinceID').val()), function (data) {
                        $('#cityContainer').html(data);
                        $("#CityID").chosen({
                            "width": "100%",
                            "height": "10px"
                        });
                        if (selectedCityID != null) {
                            $('#CityID').val(selectedCityID);
                            $('#CityID').trigger("chosen:updated");
                            $('#CityID').trigger("change");
                            selectedCityID = null;
                        }
                    });
                });

                if (selectedProvinceID != null) {
                    $('#ProvinceID').val(selectedProvinceID);
                    $('#ProvinceID').trigger("chosen:updated");
                    $('#ProvinceID').trigger("change");
                    selectedProvinceID = null;
                }

            });
        });



        $('.dataTables-example').dataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "/Client/ProviderList",
                "type": "POST"
            },
            "oLanguage": {
                "sProcessing": "<img src='/Images/loading.gif' height='25'/>"
            },
            //bFilter": false,
            "order": [[0, "asc"]],
            "bAutoWidth": false,
            "columns": [
                { "data": "Name" },
                { "data": "Group" },
                { "data": "MonthlyRateDisplay" },
                { "data": null, orderable: false, defaultContent: "<button class='btn btn-primary btn-edit'>Edit</button>" }
            ],
            @*"dom": 'T<"clear">lfrtip',
                "tableTools": {
                    "sSwfPath": "../scripts/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
                },*@
                "drawCallback": function () {
                    $(".btn-edit").unbind("click");
                    $(".btn-edit").bind("click", function () {
                        var data = $('.dataTables-example').dataTable().api().data()[$(this).parents('tr').index()];
                        EditProvider(data);
                        $("#inputImage").change(function () {
                            var fileReader = new FileReader(),
                                    files = this.files,
                                    file;

                            if (!files.length) {
                                return;
                            }

                            file = files[0];

                            if (/^image\/\w+$/.test(file.type)) {
                                fileReader.readAsDataURL(file);
                                fileReader.onload = function () {
                                    $("#inputImage").val("");

                                    var img = new Image;
                                    img.src = this.result;
                                    var source = imageToDataUri(img, 200);

                                    $("#avatar").attr("src", source);
                                };
                            } else {
                                showMessage("Please choose an image file.");
                            }
                        });

                    });
                }
            });

            $(".btn-newprovider").click(function () {
                AddProvider();
                $("#inputImage").change(function () {
                    var fileReader = new FileReader(),
                            files = this.files,
                            file;

                    if (!files.length) {
                        return;
                    }

                    file = files[0];

                    if (/^image\/\w+$/.test(file.type)) {
                        fileReader.readAsDataURL(file);
                        fileReader.onload = function () {
                            $("#inputImage").val("");

                            var img = new Image;
                            img.src = this.result;
                            var source = imageToDataUri(img, 200);

                            $("#avatar").attr("src", source);
                        };
                    } else {
                        showMessage("Please choose an image file.");
                    }
                });
            }); //End Add



            $('#popupEditor').on('hidden.bs.modal', function () {
                $(".btn-acuitytype").removeClass("btn-primary").addClass("btn-white");
                $("#form").steps("destroy");
            });

            $(".btn-closedialog").unbind("click");
            $(".btn-closedialog").bind("click", function () {
                $("#popupEditor").modal("hide");
            });

            $('#popupNewGroup').on('hidden.bs.modal', function () {
                $("#newGroupName").val("");
            });

            $(".btn-savenewgroup").unbind("click");
            $(".btn-savenewgroup").bind("click", function () {
                var model = {
                    Name: $('#newGroupName').val(),
                    IsGroup: true
                }

                Post("/Client/AddProvider", model,
                function () {
                    RefreshGroup();
                });

                $("#popupNewGroup").modal("hide");
            });

    });

        function setData(countryId, provinceId, cityId) {
            $.get("/patient/GetProvinces?CountryId=" + encodeURIComponent(countryId), function (data) {
                $('#provinceContainer').html(data);
                $("#ProvinceID").chosen({
                    "width": "100%",
                    "height": "10px"
                });


                    $.get("/patient/GetCities?ProvinceId=" + encodeURIComponent(provinceId), function (data) {
                        $('#cityContainer').html(data);
                        $("#CityID").chosen({
                            "width": "100%",
                            "height": "10px"
                        });
                        if (cityId != null) {
                            $('#CityID').val(cityId);
                            $('#CityID').trigger("chosen:updated");

                            cityId = null;
                        }
                    });


                if (provinceId != null) {
                    $('#ProvinceID').val(provinceId);
                    $('#ProvinceID').trigger("chosen:updated");
                    provinceId = null;
                }

            });
        }

        function EditProvider(data) {
            $('#errorNewProvider').css("display", "none");
            $(".btn-newnext").removeClass("disabled");
            $('.btn-newsave').addClass('disabled');
            $("#form").steps({
                bodyTag: "fieldset",
                enableFinishButton: false,
                enablePagination: false,
                onCancelled: function () {
                    $("#form").steps("destroy");
                }
            });


            $("#txtMonthlyRate").keypress(function (event) {
                if ((event.which > 47 && event.which < 58) || event.which == 46) {

                    if ($("#txtMonthlyRate").val().substring($("#txtMonthlyRate").val().indexOf('.')).length > 2 && $("#txtMonthlyRate").val().indexOf('.') != -1) {
                        event.preventDefault();
                    } else {
                        return;
                    }

                } else {
                    event.preventDefault();
                }
            });

            $(".btn-newnext").unbind("click");
            $(".btn-newnext").bind("click", function () {
                switch ($("#form").steps("getCurrentIndex")) {
                    case 0:

                        if (isNaN($('#txtMonthlyRate').val().replace(/\s+/g, ''))) {
                            return;
                        }

                        $("#form").steps("next");

                        $('#tblServiceTypeParent').html('<table class="table tblServiceType" id="tblServiceType" style="overflow-y: auto"><thead><tr><th>Service Type</th><th>Scales</th></tr></thead></table>');

                        $('#tblServiceType').DataTable({
                            paging: false,
                            ordering: false,
                            searching: false,
                            info: false,
                            autoWidth: false,
                            scrollY: "75px",
                            scrollCollapse: true,
                            "oLanguage": {
                                "sProcessing": "<img src='/Images/loading.gif' height='25'/>"
                            },
                            columns: [
                                { data: "ServiceType" },
                                { data: "Scales" },
                                { "data": null, orderable: false, defaultContent: "<button class='btn btn-danger btn-delete-servicetype'><i class='fa fa-close'></i></button>" }
                            ],
                            "drawCallback": function (settings) {
                                $("#tblServiceType tbody").unbind("dblclick");
                                $('#tblServiceType tbody').on('dblclick', 'tr', function () {
                                    EditServiceType($('#tblServiceType').DataTable().rows().row(this).data(), $('#tblServiceType').DataTable().rows().row(this));
                                });

                                $(".btn-delete-servicetype").unbind("click");
                                $(".btn-delete-servicetype").bind("click", function () {
                                    var data = $('#tblServiceType').dataTable().api().data()[$(this).parents('tr').index()];
                                    var row = $('#tblServiceType').DataTable().row($(this).parents('tr'));
                                    row.remove().draw();

                                });
                            }
                        });

                        $("#tblServiceType").DataTable().clear().draw();
                        for (i = 0; i < data.ServicesTypes.length; i++) {
                            $("#tblServiceType").DataTable().row.add({
                                ServiceType: data.ServicesTypes[i].ServiceTypeNameDisplay,
                                Scales: data.ServicesTypes[i].Scales,
                                ScaleList: data.ServicesTypes[i].ScaleList,
                                ServiceTypeID: data.ServicesTypes[i].ServiceTypeID,
                                ContactNumber: data.ServicesTypes[i].ContactNumber,
                                ProvinceID: data.ServicesTypes[i].ProvinceID,
                                CountryID: data.ServicesTypes[i].CountryID,
                                Street: data.ServicesTypes[i].Street,
                                PostalCode: data.ServicesTypes[i].PostalCode,
                                CityID: data.ServicesTypes[i].CityID,
                                ID: data.ServicesTypes[i].ID,
                                ServiceTypeScales: data.ServicesTypes[i].ServiceTypeScales

                            }).draw();
                        }

                        $("#btn-add-service-type").unbind("click");
                        $('#btn-add-service-type').click(function () {
                            AddServiceType();

                        });


                        $('.btn-newsave').removeClass('disabled');
                        $('.btn-newnext').addClass('disabled');
                        $(".btn-newsave").unbind("click");
                        $('.btn-newsave').click(function () {

                            var servicetypes = new Array();
                            for (var i = 0; i < $('#tblServiceType tr').length; i++) {
                                servicetypes.push($('#tblServiceType').DataTable().row(i).data());
                            }

                            var model = {
                                Name: $('#txtProviderName').val(),
                                ParentID: $('#GroupID').val(),
                                ServiceTypes: servicetypes,
                                ProviderID: data.ProviderID,
                                MonthlyRate: $('#txtMonthlyRate').val().replace(/\s+/g, '').replace('.', ','),
                                ProfileImage: $('#avatar').attr('src') != '/Content/images/noprovider.png' ? $("#avatar").attr('src').substring($("#avatar").attr('src').indexOf('base64,') + 7) : null
                            }

                            Post("/Client/AddProvider", model,
                            function () {
                                $("#popupNewGroup").modal("hide");
                                $(".dataTables-example").DataTable().ajax.reload();
                            });


                            $("#popupEditor").modal("hide");
                        });
                        RefreshServiceType();
                        break;
                }
            });

            $("#popupEditor").modal("show");


            $("#btnAddStructure").unbind("click");
            $("#btnAddStructure").click(function () {

                $("#popupNewGroup").modal("show");

                $('#newGroupName').focus();
            });

            RefreshGroup(data.GroupId);

            $('#addnewprovider-sub-title').html('Provider Details');
            $('#addnewprovider-title').html('Edit Provider');
            $('#txtProviderName').val(data.Name);
            $('#txtMonthlyRate').val(data.MonthlyRate);
            $("#avatar").attr("src", data.ProfileImage);

            $('#txtProviderName').focus();

        }

        function EditServiceType(data, row) {

            $('#errorNewServiceType').css("display", "none");
            $(".btn-modal-add-service").unbind("click");
            $('.btn-modal-add-service').click(function () {

                if ($('#contactNumber').val() == "" || $('#ProvinceID').val() == "" || $('#CountryID').val() == "" || $('#street').val() == "" ||
                    $('#postalCode').val() == "" || $('#CityID').val() == "") {
                    $('#errorNewServiceType').css("display", "block");
                    return;
                }

                row.remove().draw();

                var contactNumber = $('#contactNumber').val();
                var province = $('#ProvinceID').val();
                var country = $('#CountryID').val();
                var street = $('#street').val();
                var postalcode = $('#postalCode').val();
                var city = $('#CityID').val();

                var scaleList = new Array();

                $('#scalelist').children('input:checked').each(function () {
                    scaleList.push($(this).val());
                });

                var scaleDisplay = new Array();

                $('#scalelist').children('input:checked').each(function () {
                    scaleDisplay.push($(this).next('label').text());
                });

                $("#tblServiceType").DataTable().row.add({
                    ServiceType: data.ServiceType,
                    Scales: scaleDisplay,
                    ScaleList: scaleList,
                    ServiceTypeID: data.ServiceTypeID,
                    ContactNumber: contactNumber,
                    ProvinceID: province,
                    CountryID: country,
                    Street: street,
                    PostalCode: postalcode,
                    CityID: city,
                    ID: data.ID
                }).draw();

                $('#popupAddServiceType').modal('hide');

            });


            $('#contactNumber').val(data.ContactNumber);
            $('#street').val(data.Street);
            $('#postalCode').val(data.PostalCode);
            $('input:checkbox').removeAttr('checked');
            $('#CountryID').val(data.CountryID);
            selectedProvinceID = data.ProvinceID;
            selectedCityID = data.CityID;
            $('#CountryID').trigger("chosen:updated");
            $('#CountryID').trigger("change");

            for (i = 0; i < data.Scales.length; i++) {
                $('input[value="' + data.ServiceTypeScales[i].ScaleID + '"').prop('checked', true);
            }

            $('#popupAddServiceType').modal('show');
            $(".btn-modal-add-service").html("Save");
        }

        function AddServiceType() {
            $(".btn-modal-add-service").unbind("click");
            $('.btn-modal-add-service').click(function () {

                if ($('#contactNumber').val() == "" || $('#ProvinceID').val() == "" || $('#CountryID').val() == "" || $('#street').val() == "" ||
                    $('#postalCode').val() == "" || $('#CityID').val() == "") {
                    $('#errorNewServiceType').css("display", "block");
                    return;
                }


                var contactNumber = $('#contactNumber').val();
                var country = $('#CountryID').val();
                var street = $('#street').val();
                var postalcode = $('#postalCode').val();
                var province = $('#ProvinceID').val();
                var city = $('#CityID').val();

                var scaleList = new Array();

                $('#scalelist').children('input:checked').each(function () {
                    scaleList.push($(this).val());
                });

                var scaleDisplay = new Array();

                $('#scalelist').children('input:checked').each(function () {
                    scaleDisplay.push($(this).next('label').text());
                });

                $("#tblServiceType").DataTable().row.add({
                    ServiceType: $('#ServiceTypeID option:selected').parent().attr("label") + " - " + $('#ServiceTypeID option:selected').text(),
                    Scales: scaleDisplay,
                    ScaleList: scaleList,
                    ServiceTypeID: $('#ServiceTypeID option:selected').val(),
                    ContactNumber: contactNumber,
                    ProvinceID: province,
                    CountryID: country,
                    Street: street,
                    PostalCode: postalcode,
                    CityID: city
                }).draw();


                $('#contactNumber').val('');
                $('#street').val('');
                $('#postalCode').val('');
                $('#provinceContainer').html('');
                $('#cityContainer').html('');

                $('#popupAddServiceType').modal('hide');

            });

            if ($('#tblServiceType').DataTable().rows().data().length > 0) {
                var serviceTypeItem = $('#tblServiceType').DataTable().rows().data()[0];

                $('#contactNumber').val(serviceTypeItem.ContactNumber);
                $('#street').val(serviceTypeItem.Street);
                $('#postalCode').val(serviceTypeItem.PostalCode);
                $('input:checkbox').removeAttr('checked');
                $('#CountryID').val(serviceTypeItem.CountryID);
                $('#CountryID').trigger("chosen:updated");
                setData(serviceTypeItem.CountryID, serviceTypeItem.ProvinceID, serviceTypeItem.CityID);

            } else {
                $('#contactNumber').val("");
                $('#street').val("");
                $('#postalCode').val("");
                $('input:checkbox').removeAttr('checked');
                $('CountryID').val('');
                $('CountryID').trigger("chosen:updated");
                $('#provinceContainer').html("");
                $('#cityContainer').html("");

                $('#CountryID').val('@SADFM.Web.Shared.Constants.DefaultCountryId');
                $('#CountryID').trigger("chosen:updated");
                $('#CountryID').change();
            }

            

            $('#popupAddServiceType').modal('show');
            $(".btn-modal-add-service").html("Add");
        }

        function AddProvider() {

            $('#errorNewProvider').css("display", "none");
            $(".btn-newnext").removeClass("disabled");
            $('.btn-newsave').addClass('disabled');
            $("#form").steps({
                bodyTag: "fieldset",
                enableFinishButton: false,
                enablePagination: false,
                onCancelled: function () {
                    $("#form").steps("destroy");
                }
            });


            $("#txtMonthlyRate").keypress(function (event) {
                if ((event.which > 47 && event.which < 58) || event.which == 46) {

                    if ($("#txtMonthlyRate").val().substring($("#txtMonthlyRate").val().indexOf('.')).length > 2 && $("#txtMonthlyRate").val().indexOf('.') != -1) {
                        event.preventDefault();
                    } else {
                        return;
                    }

                } else {
                    event.preventDefault();
                }
            });


            $(".btn-newnext").unbind("click");
            $(".btn-newnext").bind("click", function () {
                switch ($("#form").steps("getCurrentIndex")) {
                    case 0:
                        if ( $('#txtProviderName').val() == "") {
                            $('#errorNewProvider').css("display", "block");
                            return;
                        }

                        if (isNaN($('#txtMonthlyRate').val().replace(/\s+/g, ''))) {
                            return;
                        }


                        $("#form").steps("next");

                        $('#tblServiceTypeParent').html('<table class="table tblServiceType" id="tblServiceType" style="overflow-y: auto"><thead><tr><th>Service Type</th><th>Scales</th></tr></thead></table>');

                        tblServiceType = $('#tblServiceType').DataTable({
                            paging: false,
                            ordering: false,
                            searching: false,
                            info: false,
                            autoWidth: false,
                            "oLanguage": {
                                "sProcessing": "<img src='/Images/loading.gif' height='25'/>"
                            },
                            columns: [
                                { data: "ServiceType" },
                                { data: "Scales" }
                            ]

                        });

                        $("#btn-add-service-type").unbind("click");
                        $('#btn-add-service-type').click(function () {
                            AddServiceType();

                        });


                        $('.btn-newsave').removeClass('disabled');
                        $('.btn-newnext').addClass('disabled');
                        $(".btn-newsave").unbind("click");
                        $('.btn-newsave').click(function () {


                            if ($('#tblServiceType').DataTable().rows().data().length == 0) {
                                alert('Select at least one service type');
                                return;
                            }

                            var servicetypes = new Array();
                            for (var i = 0; i < $('#tblServiceType tr').length; i++) {
                                servicetypes.push($('#tblServiceType').DataTable().row(i).data());
                            }

                            var model = {
                                Name: $('#txtProviderName').val(),
                                ParentID: $('#GroupID').val(),
                                ServiceTypes: servicetypes,
                                MonthlyRate: $('#txtMonthlyRate').val().replace(/\s+/g, '').replace('.', ','),
                                ProfileImage: $('#avatar').attr('src') != '/Content/images/noprovider.png' ? $("#avatar").attr('src').substring($("#avatar").attr('src').indexOf('base64,') + 7) : null
                            }

                            Post("/Client/AddProvider", model,
                            function () {
                                $("#popupNewGroup").modal("hide");
                                $(".dataTables-example").DataTable().ajax.reload();
                            });
                            $("#popupEditor").modal("hide");
                        });
                        RefreshServiceType();
                        $("#tblServiceType").DataTable().clear().draw();
                        break;
                }
            });


            $("#popupEditor").modal("show");

            $("#btnAddStructure").unbind("click");
            $("#btnAddStructure").click(function () {
                $("#popupNewGroup").modal("show");
                $('#newGroupName').focus();
            });

            RefreshGroup(null);



            $('#addnewprovider-sub-title').html('New Provider Details');
            $('#addnewprovider-title').html('Add a new Provider');
            $('#txtProviderName').val('');

            $('#txtProviderName').focus();
        }

        function RefreshGroup(value) {
            $('#rowddlStructure').html('');
            $.get("/Client/ProviderGroups", function (data) {
                $('#rowddlStructure').html(data);
                $('#GroupID').html("<option value=''>Select a group</option>" + $('#GroupID').html());

                $("#GroupID").chosen({
                    "width": "100%",
                    disable_search_threshold: 10
                });

                if (value != null) {
                    $('#GroupID').val(value);
                    $('#GroupID').trigger("chosen:updated");
                }

            });
        }

        function imageToDataUri(img, minSize) {

            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);

            var MAX_WIDTH = minSize;
            var MAX_HEIGHT = minSize;
            var width = img.width;
            var height = img.height;

            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }
            canvas.width = width;
            canvas.height = height;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            var dataurl = canvas.toDataURL("image/*");
            return dataurl;
        }

        function RefreshServiceType() {
            var boxComboBox = '@SADFM.Web.Shared.HtmlHelper.DropdownBox(SADFM.Data.DataAccess.ListItem.GetList("ProviderUnit").OrderBy(li => li.SortOrder).ToList(), "ServiceTypeID", l => l.ID,  l => l.Description, "chosen-select", l => l.Description, dataPlaceholder: "Select service type", subgroupText: li => string.Format("{0} - {1}", li.Code, li.Name), orderChildrenBy: li => li.SortOrder)';
        $("#ServiceTypeParent").html(boxComboBox);

        $("#ServiceTypeID").chosen({
            "width": "100%",
            search_contains: true,
            disable_search_threshold: 10
        });
        $("#btn-add-service-type").attr("disabled", true);
        $("#ServiceTypeID").change(function () {
            if ($("#ServiceTypeID").val() == "" || $("#ServiceTypeID").val() == "") {
                $("#btn-add-service-type").attr("disabled", true);
            }
            else {
                $("#btn-add-service-type").attr("disabled", false);
            }
        });
    }


    </script>
}